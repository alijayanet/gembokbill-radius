<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADIUS Management - <%= appSettings.app_name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-connected {
            background-color: #10b981;
            color: white;
        }
        .status-disconnected {
            background-color: #ef4444;
            color: white;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #6b7280;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
        }
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="/css/admin-mobile.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Include Admin Responsive Sidebar -->
        <%- include('../partials/admin-responsive-sidebar', { page: 'radius', settings: appSettings }) %>
        
        <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto main-content px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-network-wired"></i> RADIUS Management</h1>
                <p class="text-muted mb-0">Kelola server FreeRADIUS untuk otentikasi terpusat</p>
            </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="userCount"><%= userCount %></div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="connectionStatus">
                    <% if (testResult.success) { %>
                        <span class="status-badge status-connected">Connected</span>
                    <% } else { %>
                        <span class="status-badge status-disconnected">Disconnected</span>
                    <% } %>
                </div>
                <div class="stat-label">Database Status</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">RADIUS Settings</h2>
                <button class="btn btn-primary" onclick="openSettingsModal()">
                    <i class="fas fa-cog"></i> Edit Settings
                </button>
            </div>
            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="settingsTable">
                </tbody>
            </table>
        </div>

        <div id="alertContainer"></div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">RADIUS Users</h2>
                <button class="btn btn-primary" onclick="openAddUserModal()">
                    <i class="fas fa-plus"></i> Add User
                </button>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <% users.forEach(user => { %>
                        <tr>
                            <td><%= user %></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewUser('<%= user %>')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('<%= user %>')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">RADIUS Profiles</h2>
                <button class="btn btn-primary" onclick="openAddProfileModal()">
                    <i class="fas fa-plus"></i> Add Profile
                </button>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Download Speed</th>
                        <th>Upload Speed</th>
                        <th>Rate Limit</th>
                        <th>Priority</th>
                    </tr>
                </thead>
                <tbody id="profilesTable">
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">User Accounting / Usage</h2>
                <div>
                    <select id="accountingUserFilter" class="form-select" style="width: 200px; display: inline-block;">
                        <option value="">All Users</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadAccounting()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Session ID</th>
                        <th>Start Time</th>
                        <th>Duration</th>
                        <th>Upload</th>
                        <th>Download</th>
                        <th>IP Address</th>
                        <th>Terminate Cause</th>
                    </tr>
                </thead>
                <tbody id="accountingTable">
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Hotspot Users (Active)</h2>
                <button class="btn btn-primary" onclick="loadHotspotUsers()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Session Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hotspotTable">
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Hotspot Profiles (RADIUS Groups)</h2>
                <button class="btn btn-primary" onclick="openAddHotspotProfileModal()">
                    <i class="fas fa-plus"></i> Add Profile
                </button>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Rate Limit</th>
                        <th>Session Timeout</th>
                        <th>Idle Timeout</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hotspotProfilesTable">
                </tbody>
            </table>
        </div>
        </main>
    </div>
</div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add RADIUS User</h3>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Framed-IP-Address (Optional)</label>
                    <input type="text" class="form-input" id="framedIP" placeholder="e.g., 192.168.1.100">
                </div>
                <div class="form-group">
                    <label class="form-label">Framed-Pool (Optional)</label>
                    <input type="text" class="form-input" id="framedPool" placeholder="e.g., pool1">
                </div>
                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>
    </div>

    <div id="addProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add RADIUS Profile</h3>
                <button class="close-btn" onclick="closeModal('addProfileModal')">&times;</button>
            </div>
            <form id="addProfileForm">
                <div class="form-group">
                    <label class="form-label">Profile Name</label>
                    <input type="text" class="form-input" id="profileName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Download Speed</label>
                    <input type="text" class="form-input" id="downloadSpeed" required placeholder="e.g., 10M">
                </div>
                <div class="form-group">
                    <label class="form-label">Upload Speed</label>
                    <input type="text" class="form-input" id="uploadSpeed" required placeholder="e.g., 10M">
                </div>
                <div class="form-group">
                    <label class="form-label">Rate Limit (Optional)</label>
                    <input type="text" class="form-input" id="rateLimit" placeholder="e.g., 10M/10M">
                </div>
                <div class="form-group">
                    <label class="form-label">Burst Limit (Optional)</label>
                    <input type="text" class="form-input" id="burstLimit" placeholder="e.g., 15M/15M">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <input type="number" class="form-input" id="priority" value="1" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Profile</button>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">RADIUS Settings</h3>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <form id="settingsForm">
                <div class="form-group">
                    <label class="form-label">RADIUS Host</label>
                    <input type="text" class="form-input" id="radiusHost" required>
                </div>
                <div class="form-group">
                    <label class="form-label">RADIUS User</label>
                    <input type="text" class="form-input" id="radiusUser" required>
                </div>
                <div class="form-group">
                    <label class="form-label">RADIUS Password</label>
                    <input type="password" class="form-input" id="radiusPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">RADIUS Database</label>
                    <input type="text" class="form-input" id="radiusDatabase" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Isolir Group</label>
                    <input type="text" class="form-input" id="isolirGroup" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Suspension Bandwidth Limit</label>
                    <input type="text" class="form-input" id="suspensionBandwidth" required placeholder="e.g., 1k/1k">
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <div id="addHotspotProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Hotspot Profile</h3>
                <button class="close-btn" onclick="closeModal('addHotspotProfileModal')">&times;</button>
            </div>
            <form id="addHotspotProfileForm">
                <div class="form-group">
                    <label class="form-label">Profile Name</label>
                    <input type="text" class="form-input" id="hotspotProfileName" required placeholder="e.g., basic, standard, premium">
                </div>
                <div class="form-group">
                    <label class="form-label">Rate Limit (Bandwidth)</label>
                    <input type="text" class="form-input" id="hotspotRateLimit" placeholder="e.g., 5M/5M, 10M/10M">
                </div>
                <div class="form-group">
                    <label class="form-label">Session Timeout (seconds)</label>
                    <input type="number" class="form-input" id="hotspotSessionTimeout" placeholder="e.g., 3600 (1 hour)">
                </div>
                <div class="form-group">
                    <label class="form-label">Idle Timeout (seconds)</label>
                    <input type="number" class="form-input" id="hotspotIdleTimeout" placeholder="e.g., 300 (5 minutes)">
                </div>
                <button type="submit" class="btn btn-primary">Add Profile</button>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showAlert(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
            $('#alertContainer').html(alertHtml);
            setTimeout(() => {
                $('#alertContainer').empty();
            }, 5000);
        }

        function openAddUserModal() {
            $('#addUserModal').css('display', 'flex');
        }

        function openAddProfileModal() {
            $('#addProfileModal').css('display', 'flex');
        }

        function openAddHotspotProfileModal() {
            $('#addHotspotProfileModal').css('display', 'flex');
        }

        function openSettingsModal() {
            $('#settingsModal').css('display', 'flex');
            loadSettings();
        }

        function closeModal(modalId) {
            $(`#${modalId}`).css('display', 'none');
            if (modalId === 'addHotspotProfileModal') {
                editingHotspotProfile = null;
                $('#hotspotProfileName').prop('readonly', false);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/admin/radius/settings');
                const result = await response.json();
                if (result.success) {
                    const settings = result.settings || {};
                    $('#radiusHost').val(settings.radius_host || '');
                    $('#radiusUser').val(settings.radius_user || '');
                    $('#radiusPassword').val(settings.radius_password || '');
                    $('#radiusDatabase').val(settings.radius_database || '');
                    $('#isolirGroup').val(settings.isolir_radius_group || '');
                    $('#suspensionBandwidth').val(settings.suspension_bandwidth_limit || '');

                    // Update settings table
                    let html = '';
                    const settingLabels = {
                        radius_host: 'RADIUS Host',
                        radius_user: 'RADIUS User',
                        radius_password: 'RADIUS Password',
                        radius_database: 'RADIUS Database',
                        isolir_radius_group: 'Isolir Group',
                        suspension_bandwidth_limit: 'Suspension Bandwidth Limit'
                    };
                    
                    for (const [key, value] of Object.entries(settings)) {
                        const displayValue = key === 'radius_password' ? '******' : (value || '-');
                        html += `
                            <tr>
                                <td>${settingLabels[key] || key}</td>
                                <td>${displayValue}</td>
                            </tr>
                        `;
                    }
                    $('#settingsTable').html(html);
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert(`Error loading settings: ${error.message}`, 'error');
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    radius_host: $('#radiusHost').val(),
                    radius_user: $('#radiusUser').val(),
                    radius_password: $('#radiusPassword').val(),
                    radius_database: $('#radiusDatabase').val(),
                    isolir_radius_group: $('#isolirGroup').val(),
                    suspension_bandwidth_limit: $('#suspensionBandwidth').val()
                };

                const response = await fetch('/admin/radius/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('Settings saved successfully', 'success');
                    closeModal('settingsModal');
                    loadSettings();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error saving settings: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            try {
                const response = await fetch('/admin/radius/test-connection');
                const result = await response.json();
                if (result.success) {
                    showAlert('RADIUS connection successful!', 'success');
                    updateConnectionStatus(true);
                } else {
                    showAlert(`Connection failed: ${result.message}`, 'error');
                    updateConnectionStatus(false);
                }
            } catch (error) {
                showAlert(`Error testing connection: ${error.message}`, 'error');
            }
        }

        function updateConnectionStatus(connected) {
            const statusHtml = connected 
                ? '<span class="status-badge status-connected">Connected</span>'
                : '<span class="status-badge status-disconnected">Disconnected</span>';
            $('#connectionStatus').html(statusHtml);
        }

        async function loadUsers() {
            try {
                const response = await fetch('/admin/radius/users');
                const result = await response.json();
                if (result.success) {
                    const users = result.users || [];
                    let html = '';
                    if (users.length === 0) {
                        html = '<tr><td colspan="2" style="text-align: center;">No RADIUS users found</td></tr>';
                    } else {
                        users.forEach(user => {
                            html += `
                                <tr>
                                    <td>${user}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="viewUser('${user}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    $('#usersTable').html(html);
                    $('#userCount').text(users.length);
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert(`Error loading users: ${error.message}`, 'error');
            }
        }

        async function viewUser(username) {
            try {
                const response = await fetch(`/admin/radius/users/${username}`);
                const result = await response.json();
                if (result.success && result.user) {
                    const user = result.user;
                    const checkInfo = user.check && user.check.length > 0 
                        ? `Password: ${user.check[0].value || 'N/A'}`
                        : 'No password info';
                    const replyInfo = user.reply && user.reply.length > 0
                        ? user.reply.map(r => `${r.attribute}: ${r.value}`).join('\n')
                        : 'No reply attributes';
                    const groupInfo = user.groups && user.groups.length > 0
                        ? user.groups.map(g => `Group: ${g.groupname} (Priority: ${g.priority})`).join('\n')
                        : 'No groups';
                    
                    alert(`User: ${user.username}\n\n${checkInfo}\n\nReply Attributes:\n${replyInfo}\n\n${groupInfo}`);
                } else {
                    showAlert(`Error: ${result.message || 'User not found'}`, 'error');
                }
            } catch (error) {
                console.error('Error viewing user:', error);
                showAlert(`Error viewing user: ${error.message}`, 'error');
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/radius/users/${username}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showAlert(`User ${username} deleted successfully`, 'success');
                    loadUsers();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error deleting user: ${error.message}`, 'error');
            }
        }

        async function syncAllCustomers() {
            if (!confirm('This will sync all customers with RADIUS enabled. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/admin/radius/sync-all-customers', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    const summary = result.summary || {};
                    showAlert(`Sync completed: ${summary.success || 0} successful, ${summary.failure || 0} failed`, 'success');
                    loadUsers();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error syncing customers:', error);
                showAlert(`Error syncing customers: ${error.message}`, 'error');
            }
        }

        async function loadProfiles() {
            try {
                const response = await fetch('/admin/radius/profiles');
                const result = await response.json();
                if (result.success) {
                    const profiles = result.profiles || [];
                    let html = '';
                    if (profiles.length === 0) {
                        html = '<tr><td colspan="5" style="text-align: center;">No RADIUS profiles found</td></tr>';
                    } else {
                        profiles.forEach(profile => {
                            html += `
                                <tr>
                                    <td>${profile.name}</td>
                                    <td>${profile.download_speed}</td>
                                    <td>${profile.upload_speed}</td>
                                    <td>${profile.rate_limit || '-'}</td>
                                    <td>${profile.priority}</td>
                                </tr>
                            `;
                        });
                    }
                    $('#profilesTable').html(html);
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                showAlert(`Error loading profiles: ${error.message}`, 'error');
            }
        }

        async function loadAccounting() {
            try {
                const usernameFilter = $('#accountingUserFilter').val();
                const url = usernameFilter 
                    ? `/admin/radius/accounting?username=${encodeURIComponent(usernameFilter)}`
                    : '/admin/radius/accounting';
                
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    const sessions = result.sessions || [];
                    let html = '';
                    if (sessions.length === 0) {
                        html = '<tr><td colspan="8" style="text-align: center;">No accounting data found</td></tr>';
                    } else {
                        sessions.forEach(session => {
                            const startTime = session.acctstarttime ? new Date(session.acctstarttime).toLocaleString() : '-';
                            const duration = session.acctsessiontime ? formatDuration(session.acctsessiontime) : '-';
                            const upload = session.acctinputoctets ? formatBytes(session.acctinputoctets) : '0 B';
                            const download = session.acctoutputoctets ? formatBytes(session.acctoutputoctets) : '0 B';
                            const ip = session.framedipaddress || '-';
                            const cause = session.acctterminatecause || '-';
                            
                            html += `
                                <tr>
                                    <td>${session.username || '-'}</td>
                                    <td>${session.acctsessionid || '-'}</td>
                                    <td>${startTime}</td>
                                    <td>${duration}</td>
                                    <td>${upload}</td>
                                    <td>${download}</td>
                                    <td>${ip}</td>
                                    <td>${cause}</td>
                                </tr>
                            `;
                        });
                    }
                    $('#accountingTable').html(html);
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error loading accounting:', error);
                showAlert(`Error loading accounting: ${error.message}`, 'error');
            }
        }

        async function loadAccountingUsers() {
            try {
                const response = await fetch('/admin/radius/users');
                const result = await response.json();
                if (result.success) {
                    const users = result.users || [];
                    let html = '<option value="">All Users</option>';
                    users.forEach(user => {
                        html += `<option value="${user}">${user}</option>`;
                    });
                    $('#accountingUserFilter').html(html);
                } else {
                    console.error('Error loading users for accounting filter:', result.message);
                }
            } catch (error) {
                console.error('Error loading users for accounting filter:', error);
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function loadHotspotUsers() {
            try {
                const response = await fetch('/admin/radius/hotspot-users');
                const result = await response.json();
                if (result.success) {
                    const users = result.users || [];
                    let html = '';
                    if (users.length === 0) {
                        html = '<tr><td colspan="5" style="text-align: center;">No active hotspot users found</td></tr>';
                    } else {
                        users.forEach(user => {
                            const sessionTime = user.uptime || user.sessionTime || '-';
                            html += `
                                <tr>
                                    <td>${user.username || '-'}</td>
                                    <td>${user.address || '-'}</td>
                                    <td>${user['mac-address'] || user.macAddress || '-'}</td>
                                    <td>${sessionTime}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="disconnectHotspotUser('${user.username}')">
                                            <i class="fas fa-power-off"></i> Disconnect
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    $('#hotspotTable').html(html);
                } else {
                    console.error('Error loading hotspot users:', result.message);
                    $('#hotspotTable').html('<tr><td colspan="5" style="text-align: center;">Error loading hotspot users</td></tr>');
                }
            } catch (error) {
                console.error('Error loading hotspot users:', error);
                $('#hotspotTable').html('<tr><td colspan="5" style="text-align: center;">Error loading hotspot users</td></tr>');
            }
        }

        async function disconnectHotspotUser(username) {
            if (!confirm(`Are you sure you want to disconnect user ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/radius/hotspot-users/${username}/disconnect`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    showAlert(`User ${username} disconnected successfully`, 'success');
                    loadHotspotUsers();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error disconnecting user: ${error.message}`, 'error');
            }
        }

        async function loadHotspotProfiles() {
            try {
                const response = await fetch('/admin/radius/hotspot-profiles');
                const result = await response.json();
                if (result.success) {
                    const profiles = result.profiles || [];
                    let html = '';
                    if (profiles.length === 0) {
                        html = '<tr><td colspan="5" style="text-align: center;">No hotspot profiles found</td></tr>';
                    } else {
                        profiles.forEach(profile => {
                            html += `
                                <tr>
                                    <td>${profile.name}</td>
                                    <td>${profile.rateLimit || '-'}</td>
                                    <td>${profile.sessionTimeout ? formatDuration(profile.sessionTimeout) : '-'}</td>
                                    <td>${profile.idleTimeout ? formatDuration(profile.idleTimeout) : '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editHotspotProfile('${profile.name}')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteHotspotProfile('${profile.name}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    $('#hotspotProfilesTable').html(html);
                } else {
                    console.error('Error loading hotspot profiles:', result.message);
                    $('#hotspotProfilesTable').html('<tr><td colspan="5" style="text-align: center;">Error loading hotspot profiles</td></tr>');
                }
            } catch (error) {
                console.error('Error loading hotspot profiles:', error);
                $('#hotspotProfilesTable').html('<tr><td colspan="5" style="text-align: center;">Error loading hotspot profiles</td></tr>');
            }
        }

        async function deleteHotspotProfile(name) {
            if (!confirm(`Are you sure you want to delete hotspot profile ${name}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/radius/hotspot-profiles/${name}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showAlert(`Profile ${name} deleted successfully`, 'success');
                    loadHotspotProfiles();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error deleting profile: ${error.message}`, 'error');
            }
        }

        let editingHotspotProfile = null;

        async function editHotspotProfile(name) {
            try {
                const response = await fetch('/admin/radius/hotspot-profiles');
                const result = await response.json();
                if (result.success) {
                    const profile = result.profiles.find(p => p.name === name);
                    if (profile) {
                        editingHotspotProfile = name;
                        $('#hotspotProfileName').val(profile.name).prop('readonly', true);
                        $('#hotspotRateLimit').val(profile.rateLimit || '');
                        $('#hotspotSessionTimeout').val(profile.sessionTimeout || '');
                        $('#hotspotIdleTimeout').val(profile.idleTimeout || '');
                        openAddHotspotProfileModal();
                    }
                }
            } catch (error) {
                showAlert(`Error loading profile: ${error.message}`, 'error');
            }
        }

        $('#addUserForm').on('submit', async function(e) {
            e.preventDefault();
            const username = $('#username').val();
            const password = $('#password').val();
            const framedIP = $('#framedIP').val();
            const framedPool = $('#framedPool').val();

            const attributes = {};
            if (framedIP) attributes['Framed-IP-Address'] = framedIP;
            if (framedPool) attributes['Framed-Pool'] = framedPool;

            try {
                const response = await fetch('/admin/radius/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, attributes })
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('User added successfully', 'success');
                    closeModal('addUserModal');
                    $('#addUserForm')[0].reset();
                    loadUsers();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error adding user: ${error.message}`, 'error');
            }
        });

        $('#addProfileForm').on('submit', async function(e) {
            e.preventDefault();
            const profileData = {
                name: $('#profileName').val(),
                download_speed: $('#downloadSpeed').val(),
                upload_speed: $('#uploadSpeed').val(),
                rate_limit: $('#rateLimit').val() || null,
                burst_limit: $('#burstLimit').val() || null,
                priority: parseInt($('#priority').val())
            };

            try {
                const response = await fetch('/admin/radius/profiles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('Profile added successfully', 'success');
                    closeModal('addProfileModal');
                    $('#addProfileForm')[0].reset();
                    loadProfiles();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showAlert(`Error adding profile: ${error.message}`, 'error');
            }
        });

        $('#settingsForm').on('submit', function(e) {
            e.preventDefault();
            saveSettings();
        });

        $('#addHotspotProfileForm').on('submit', async function(e) {
            e.preventDefault();
            const profileData = {
                name: $('#hotspotProfileName').val(),
                rateLimit: $('#hotspotRateLimit').val(),
                sessionTimeout: $('#hotspotSessionTimeout').val(),
                idleTimeout: $('#hotspotIdleTimeout').val()
            };

            try {
                const isEditing = editingHotspotProfile !== null;
                const url = isEditing ? `/admin/radius/hotspot-profiles/${editingHotspotProfile}` : '/admin/radius/hotspot-profiles';
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });
                const result = await response.json();
                if (result.success) {
                    showAlert(isEditing ? 'Hotspot profile updated successfully' : 'Hotspot profile added successfully', 'success');
                    closeModal('addHotspotProfileModal');
                    $('#addHotspotProfileForm')[0].reset();
                    $('#hotspotProfileName').prop('readonly', false);
                    editingHotspotProfile = null;
                    loadHotspotProfiles();
                } else {
                    showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error saving hotspot profile:', error);
                showAlert(`Error saving hotspot profile: ${error.message}`, 'error');
            }
        });

        $('#accountingUserFilter').on('change', function() {
            loadAccounting();
        });

        $(document).ready(function() {
            loadUsers();
            loadProfiles();
            loadSettings();
            loadAccountingUsers();
            loadAccounting();
            loadHotspotUsers();
            loadHotspotProfiles();
        });
    </script>
</body>
</html>
